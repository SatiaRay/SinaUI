name: ðŸ§ª Deploy Production

on:
  push:
    branches:
      - 'master'
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸ›  Deploy Production Server
    runs-on: prod-runner # You may need a different runner for production

    steps:
      - name: ðŸ“¥ Pull or Clone Repository
        run: |
          PROJECT_DIR="/srv/projects/ai-react"
          BRANCH="${{ github.ref_name }}"

          if [ -d "$PROJECT_DIR/.git" ]; then
            echo "ðŸ”„ Project already cloned. Pulling latest changes..."
            cd "$PROJECT_DIR"
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git pull origin "$BRANCH"
          else
            echo "ðŸ“¦ Cloning fresh project..."
            git clone -b "$BRANCH" git@github.com:satiarepomahmoudi/ai-react.git "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            npm install
          fi

      - name: ðŸš§ Build Docker Image for Production
        run: |
          cd /srv/projects/ai-react
          docker build --build-arg REACT_APP_ENV_FILE=.env.production -t react-app-prod .

      - name: ðŸš€ Deploy with Docker
        run: |
          cd /srv/projects/ai-react
          docker run -d -p 80:80 react-app-prod

      - name: âœ… Done
        run: echo "âœ” Production deployed with Docker!"
